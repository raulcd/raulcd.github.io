<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Raúl Cumplido - Raúl Cumplido</title>
        <link rel="stylesheet" href="http://raulcd.com/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://raulcd.com/">Raúl Cumplido </a></h1>
                <nav><ul>
                    <li><a href="http://raulcd.com/pages/about-raul-cumplido.html">About Raúl Cumplido</a></li>
                    <li><a href="http://raulcd.com/category/articles.html">articles</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://raulcd.com/how-python-caches-compiled-bytecode.html">How Python caches compiled bytecode.</a></h1>
<footer class="post-info">
        <abbr class="published" title="2015-03-17T11:30:00+01:00">
                Published: Tue 17 March 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://raulcd.com/author/raul-cumplido.html">Raúl Cumplido</a>
        </address>
<p>In <a href="http://raulcd.com/category/articles.html">articles</a>. </p>

</footer><!-- /.post-info --><p>While reading an email at the Python developers mailing list about PEP-488 (which is not yet approved and is under discussion) I wondered how bytecode files works in Python.</p>
<p>The purpose of this post is to take some notes for myself and share what I find.</p>
<h2>PEP-3147</h2>
<p>While I was reading the proposed PEP-488 (which will be explained later) there was several references to <a href="https://www.python.org/dev/peps/pep-3147">PEP-3147</a>.</p>
<p>Before PEP-3147 was implemented, files were saved with the format <code>'{filename}.pyc'</code> (or .pyo) in the same directory where the source code was stored.</p>
<p>PEP-3147 was created as an extension to the Python import mechanism in order to improve sharing of compiled Python bytecode for different distributions with the sourcecode.</p>
<p>CPython compiles its source code into <code>bytecode</code>. For performance reasons Python doesn't recompile every time, so it caches the content of the compiled code. Python only recompiles when it realizes the source code file has changed. Python stores in the cached compiled file two 32bit big-endian digits which represents a <strong><em>magic number</em></strong> and a timestamp. The magic number changes every time the Python distribution changes the bytecode (for example adding new bytecode instructions to the virtual machine). This prevents causing problems when trying to execute compiled code for different virtual machines.</p>
<p>As some distributions have different versions of Python installed and users can install their different versions the previous mechanism doesn't allow to reuse the compiled files.</p>
<p>PEP-3147 extended this by creating on every package a <code>__pycache__</code> directory which can contain different versions of the compiled files. The format of the names is now <code>{filename}.{tag}.pyc</code>. The tag can be seen on the <code>imp module</code>:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">imp</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">imp</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>
<span class="s">&#39;cpython-34&#39;</span>
</pre></div>


<p>The magic number used on the pyc files can also be found on this module:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">imp</span><span class="o">.</span><span class="n">get_magic</span><span class="p">()</span>
<span class="n">b</span><span class="s">&#39;</span><span class="se">\xee\x0c\r\n</span><span class="s">&#39;</span>
</pre></div>


<p>As expected when using another version of Python the magic numbers change:</p>
<div class="highlight"><pre><span class="n">Python</span> <span class="mf">3.5</span><span class="o">.</span><span class="mi">0</span><span class="n">a0</span> <span class="p">(</span><span class="n">default</span><span class="p">:</span><span class="n">c0d25de5919e</span><span class="p">,</span> <span class="n">Jan</span> <span class="mi">30</span> <span class="mi">2015</span><span class="p">,</span> <span class="mi">22</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mi">54</span><span class="p">)</span>
<span class="p">[</span><span class="n">GCC</span> <span class="mf">4.2</span><span class="o">.</span><span class="mi">1</span> <span class="n">Compatible</span> <span class="n">Apple</span> <span class="n">LLVM</span> <span class="mf">6.0</span> <span class="p">(</span><span class="n">clang</span><span class="o">-</span><span class="mf">600.0</span><span class="o">.</span><span class="mi">56</span><span class="p">)]</span> <span class="n">on</span> <span class="n">darwin</span>
<span class="n">Type</span> <span class="s">&quot;help&quot;</span><span class="p">,</span> <span class="s">&quot;copyright&quot;</span><span class="p">,</span> <span class="s">&quot;credits&quot;</span> <span class="ow">or</span> <span class="s">&quot;license&quot;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">imp</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">imp</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>
<span class="s">&#39;cpython-35&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">imp</span><span class="o">.</span><span class="n">get_magic</span><span class="p">()</span>
<span class="n">b</span><span class="s">&#39;</span><span class="se">\xf8\x0c\r\n</span><span class="s">&#39;</span>
</pre></div>


<p>PEP-3147 was introduced on python 3.2 if we try with Python 2.7.9 we can verify that <code>get_magic()</code> exists but not <code>get_tag()</code>:</p>
<div class="highlight"><pre><span class="n">Python</span> <span class="mf">2.7</span><span class="o">.</span><span class="mi">9</span> <span class="p">(</span><span class="n">v2</span><span class="o">.</span><span class="mf">7.9</span><span class="p">:</span><span class="mi">648</span><span class="n">dcafa7e5f</span><span class="p">,</span> <span class="n">Dec</span> <span class="mi">10</span> <span class="mi">2014</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">46</span><span class="p">)</span>
<span class="p">[</span><span class="n">GCC</span> <span class="mf">4.2</span><span class="o">.</span><span class="mi">1</span> <span class="p">(</span><span class="n">Apple</span> <span class="n">Inc</span><span class="o">.</span> <span class="n">build</span> <span class="mi">5666</span><span class="p">)</span> <span class="p">(</span><span class="n">dot</span> <span class="mi">3</span><span class="p">)]</span> <span class="n">on</span> <span class="n">darwin</span>
<span class="n">Type</span> <span class="s">&quot;help&quot;</span><span class="p">,</span> <span class="s">&quot;copyright&quot;</span><span class="p">,</span> <span class="s">&quot;credits&quot;</span> <span class="ow">or</span> <span class="s">&quot;license&quot;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">imp</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">imp</span><span class="o">.</span><span class="n">get_magic</span><span class="p">()</span>
<span class="s">&#39;</span><span class="se">\x03\xf3\r\n</span><span class="s">&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">imp</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">AttributeError</span><span class="p">:</span> <span class="s">&#39;module&#39;</span> <span class="nb">object</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s">&#39;get_tag&#39;</span>
</pre></div>


<p>This is why if we use Python2 we still see the <code>.pyc</code> or <code>.pyo</code> files amongst with our code:</p>
<div class="highlight"><pre><span class="go">.</span>
<span class="go">|-- __init__.py</span>
<span class="go">|-- __init__.pyc</span>
<span class="go">|-- api.py</span>
<span class="go">|-- api.pyc</span>
<span class="go">|-- module</span>
<span class="go">|   |-- __init__.py</span>
<span class="go">|   |-- __init__.pyc</span>
<span class="go">|   |-- raul.py</span>
<span class="go">|   |-- raul.pyc</span>
</pre></div>


<p>If the PEP has been implemented we can see something like this:</p>
<div class="highlight"><pre><span class="go">|-- meteora</span>
<span class="go">|   |-- __init__.py</span>
<span class="go">|   |-- __pycache__</span>
<span class="go">|   |   |-- __init__.cpython-35.pyc</span>
<span class="go">|   |   |-- __init__.cpython-34.pyc</span>
<span class="go">|   |   |-- utils.cpython-35.pyc</span>
<span class="go">|   |   `-- utils.cpython-34.pyc</span>
<span class="go">|   `-- utils.py</span>
</pre></div>


<h2>To recompile or not to recompile</h2>
<p>The next diagram has been extracted directly from the PEP-3147 which explains clearly what is the workflow to load/compile the bytecode when importing:</p>
<p><img alt="PEP 3147 Workflow" src="http://raulcd.com/images/pep-3147-1.png" /></p>
<p>As previously explained the <code>pyc</code> file matches when both the magic number and the timestamp of the source file matches exactly in the compiled file.</p>
<p>When Python is asked to <code>import foo</code> it searches on <code>sys.path</code> if the file exists. If it is not found it checks whether there is a <code>foo.pyc</code> file. In case the <code>foo.pyc</code> file exists it will load it. Otherwise it will raise an ImportError.</p>
<p>If the file <code>foo.py</code> exists Python will check if there is a <code>__pycache__/foo.{magic}.pyc</code> file that matches the source file. In the case of match it will load it.</p>
<p>If the <code>__pycache__/foo.{magic}.pyc</code> doesn't exist or doesn't match (timestamp changed) it checks whether the <code>__pycache__</code> directory has been created or not, and if it's not created it creates it.</p>
<p>Finally it compiles the <code>foo.py</code> file and it generates the <code>__pycache__/foo.{magic}.pyc</code> file. </p>
<h2>PEP-488</h2>
<p>The purpose of the (not yet approved) PEP is to remove the PYO files which are Python Bytecode Optimized files.</p>
<h3>Current behaviour:</h3>
<p>Currently bytecode files can be PYC and PYO. A PYC file is a bytecode file when no optimization level has been applied on startup.
PYO files are files that are generated when optimization has been specified (<code>-O</code> or <code>-OO</code>).</p>
<p>In order to test the different levels of optimizations I've created the next simple test:</p>
<div class="highlight"><pre><span class="go">.</span>
<span class="go">|-- api</span>
<span class="go">    |-- __init__.py</span>
</pre></div>


<p>My <code>__init__.py</code> file consists of:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is my test function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="bp">False</span> <span class="o">==</span> <span class="bp">True</span>
</pre></div>


<p>If we execute python without any optimization we can see that the docstring of our function is there and the assertion fails as it's executed:</p>
<div class="highlight"><pre><span class="go">raulcd@test  $ python3</span>
<span class="go">Python 3.4.2 (v3.4.2:ab2c023a9432, Oct  5 2014, 20:42:22)</span>
<span class="go">[GCC 4.2.1 (Apple Inc. build 5666) (dot 3)] on darwin</span>
<span class="go">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span>
<span class="gp">&gt;</span>&gt;&gt; import api
<span class="gp">&gt;</span>&gt;&gt; api.test.__doc__
<span class="go">&#39;\n    This is my test function\n    &#39;</span>
<span class="gp">&gt;</span>&gt;&gt; api.test<span class="o">()</span>
<span class="go">Traceback (most recent call last):</span>
<span class="go">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="go">  File &quot;/Users/raulcd/test/api/__init__.py&quot;, line 5, in test</span>
<span class="go">    assert False == True</span>
<span class="go">AssertionError</span>
<span class="gp">&gt;</span>&gt;&gt;
</pre></div>


<p>We can also verify that the compiled bytecode is:</p>
<div class="highlight"><pre><span class="go">.</span>
<span class="go">`-- api</span>
<span class="go">    |-- __init__.py</span>
<span class="go">    `-- __pycache__</span>
<span class="go">        `-- __init__.cpython-34.pyc</span>
</pre></div>


<p>When we execute with <code>-O</code> we can see that assertion doesn't fail as this optimization removes the assertions from our code:</p>
<div class="highlight"><pre><span class="go">raulcd@test  $ python3 -O</span>
<span class="go">Python 3.4.2 (v3.4.2:ab2c023a9432, Oct  5 2014, 20:42:22)</span>
<span class="go">[GCC 4.2.1 (Apple Inc. build 5666) (dot 3)] on darwin</span>
<span class="go">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span>
<span class="gp">&gt;</span>&gt;&gt; import api
<span class="gp">&gt;</span>&gt;&gt; api.test.__doc__
<span class="go">&#39;\n    This is my test function\n    &#39;</span>
<span class="gp">&gt;</span>&gt;&gt; api.test<span class="o">()</span>
<span class="gp">&gt;</span>&gt;&gt;
</pre></div>


<p>We can also see that the compiled file generated is:</p>
<div class="highlight"><pre><span class="go">.</span>
<span class="go">`-- api</span>
<span class="go">    |-- __init__.py</span>
<span class="go">    `-- __pycache__</span>
<span class="go">        |-- __init__.cpython-34.pyc</span>
<span class="go">        `-- __init__.cpython-34.pyo</span>

<span class="go">2 directories, 3 files</span>
<span class="go">raulcd@test  $ ls -lrt api/__pycache__/</span>
<span class="go">total 16</span>
<span class="go">-rw-r--r--  1 raulcd  staff  280 Mar 17 11:19 __init__.cpython-34.pyc</span>
<span class="go">-rw-r--r--  1 raulcd  staff  247 Mar 17 11:23 __init__.cpython-34.pyo</span>
</pre></div>


<p>If we execute Python with <code>-OO</code> we can see that both the assertion and the docstring have disappeared. Note that I need to manually remove the <code>.pyo</code> file as Python import mechanism will not recompile (as per the workflow explained before, file has not changed and already exists the <code>.pyo</code> file):</p>
<div class="highlight"><pre><span class="go">raulcd@test  $ rm api/__pycache__/__init__.cpython-34.pyo</span>
<span class="go">raulcd@test  $ python3 -OO</span>
<span class="go">Python 3.4.2 (v3.4.2:ab2c023a9432, Oct  5 2014, 20:42:22)</span>
<span class="go">[GCC 4.2.1 (Apple Inc. build 5666) (dot 3)] on darwin</span>
<span class="go">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span>
<span class="gp">&gt;</span>&gt;&gt; import api
<span class="gp">&gt;</span>&gt;&gt; api.test.__doc__
<span class="gp">&gt;</span>&gt;&gt; api.test<span class="o">()</span>
<span class="gp">&gt;</span>&gt;&gt;
</pre></div>


<p>The generated <code>.pyo</code> file has the same name but we can see that the content is different and the size:</p>
<div class="highlight"><pre><span class="go">.</span>
<span class="go">`-- api</span>
<span class="go">    |-- __init__.py</span>
<span class="go">    `-- __pycache__</span>
<span class="go">        |-- __init__.cpython-34.pyc</span>
<span class="go">        `-- __init__.cpython-34.pyo</span>

<span class="go">2 directories, 3 files</span>
<span class="go">raulcd@test  $ ls -lrt api/__pycache__/</span>
<span class="go">total 16</span>
<span class="go">-rw-r--r--  1 raulcd  staff  280 Mar 17 11:19 __init__.cpython-34.pyc</span>
<span class="go">-rw-r--r--  1 raulcd  staff  211 Mar 17 11:28 __init__.cpython-34.pyo</span>
</pre></div>


<p>Currently there is no way to know whether a PYO file has been executed with different levels of optimization. So when a new level of optimization wants to be applied all PYO files need to be removed and regenerated.</p>
<h3>PEP-488 Proposal</h3>
<p>The PEP proposes to remove PYO files by adding the optimization level applied to the PYC file incorporating it to the file name.</p>
<p>Currently bytecode files names are created by <code>importlib.util.cache_from_source()</code> using the expression defined on PEP 3147:</p>
<div class="highlight"><pre><span class="p">{</span><span class="n">name</span><span class="p">}</span><span class="o">.</span><span class="p">{</span><span class="n">cache_tag</span><span class="p">}</span><span class="o">.</span><span class="n">pyc</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">module_name</span><span class="p">,</span> <span class="n">cache_tag</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">implemenetation</span><span class="o">.</span><span class="n">cache_tag</span><span class="p">)</span>
</pre></div>


<p>The PEP proposes to add the optimization level by modifiying the name to:</p>
<div class="highlight"><pre><span class="p">{</span><span class="n">name</span><span class="p">}</span><span class="o">.</span><span class="p">{</span><span class="n">cache_tag</span><span class="p">}</span><span class="o">.</span><span class="n">opt</span><span class="o">-</span><span class="p">{</span><span class="n">optimization</span><span class="p">}</span><span class="o">.</span><span class="n">pyc</span><span class="s">&#39;.format(</span>
    <span class="n">name</span><span class="o">=</span><span class="n">module_name</span><span class="p">,</span> <span class="n">cache_tag</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">implementation</span><span class="o">.</span><span class="n">cache_tag</span><span class="p">,</span>
    <span class="n">optimization</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">optimize</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>


<p>The "opt-" prefix was choosen to provide a visual separator from the cache tag.</p>
<p>And that's all for today :)</p><p>There are <a href="http://raulcd.com/how-python-caches-compiled-bytecode.html#disqus_thread">comments</a>.</p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="http://raulcd.com/elasticsearch-logstash-and-kibana-on-docker.html" rel="bookmark"
                           title="Permalink to Elasticsearch, Logstash and Kibana on Docker">Elasticsearch, Logstash and Kibana on Docker</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-02-11T18:30:00+01:00">
                Published: Wed 11 February 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://raulcd.com/author/raul-cumplido.html">Raúl Cumplido</a>
        </address>
<p>In <a href="http://raulcd.com/category/articles.html">articles</a>. </p>

</footer><!-- /.post-info -->                <p>Set up Elasticsearch - Logstash - Kibana stack in a Docker container</p>
                <a class="readmore" href="http://raulcd.com/elasticsearch-logstash-and-kibana-on-docker.html">read more</a>
<p>There are <a href="http://raulcd.com/elasticsearch-logstash-and-kibana-on-docker.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="http://raulcd.com/create-blog-using-pelican-and-deploy-in-github-pages.html" rel="bookmark"
                           title="Permalink to Create Blog using Pelican and deploy in github pages">Create Blog using Pelican and deploy in github pages</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-07-07T18:30:00+02:00">
                Published: Mon 07 July 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://raulcd.com/author/raul-cumplido.html">Raúl Cumplido</a>
        </address>
<p>In <a href="http://raulcd.com/category/articles.html">articles</a>. </p>

</footer><!-- /.post-info -->                <p>How to create your Pelican Blog and deploy on github pages</p>
                <a class="readmore" href="http://raulcd.com/create-blog-using-pelican-and-deploy-in-github-pages.html">read more</a>
<p>There are <a href="http://raulcd.com/create-blog-using-pelican-and-deploy-in-github-pages.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="http://twitter.com/raulcumplido">twitter</a></li>
                            <li><a href="http://github.com/raulcd">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'raulcd';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>