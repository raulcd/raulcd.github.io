<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Elasticsearch, Logstash and Kibana on Docker</title>
        <link rel="stylesheet" href="http://raulcd.com/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://raulcd.com/">Raúl Cumplido </a></h1>
                <nav><ul>
                    <li><a href="http://raulcd.com/pages/about-raul-cumplido.html">About Raúl Cumplido</a></li>
                    <li class="active"><a href="http://raulcd.com/category/articles.html">articles</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://raulcd.com/elasticsearch-logstash-and-kibana-on-docker.html" rel="bookmark"
           title="Permalink to Elasticsearch, Logstash and Kibana on Docker">Elasticsearch, Logstash and Kibana on Docker</a></h1>
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="raulcd">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-02-11T18:30:00+01:00">
                Published: Wed 11 February 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://raulcd.com/author/raul-cumplido.html">Raúl Cumplido</a>
        </address>
<p>In <a href="http://raulcd.com/category/articles.html">articles</a>. </p>

</footer><!-- /.post-info -->      <p>While doing performance testing on a project I needed to process the access logs
of our web servers to define the navigation profile of our current users. </p>
<p>So I though it would be a nice time to play with Elasticsearch, Logstash and Kibana 
as I've heard of the stack.</p>
<h2>ELK Stack</h2>
<p>The first thing to notice when using it is how easy to use is. It took me a couple of hours
since I decided to use it to have a prototype working on my local host. So let's see each one of them.</p>
<p><img alt="kibana stack image" src="http://raulcd.com/images/log-logstash-elasticsearch-kibana-flow-small.jpg" /></p>
<h3>Elasticsearch</h3>
<p><a href="http://www.elasticsearch.org/overview/elasticsearch">Elasticsearch</a> is a search server based on Lucene. 
Is Open Source and can be found on the <a href="https://github.com/elasticsearch/elasticsearch">Github Elasticsearch project</a></p>
<p>In order to set up Elastic Search the only thing that you need to do is, download the package and execute it:</p>
<div class="highlight"><pre><span class="go">➜  wget https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-1.4.2.tar.gz</span>
<span class="go">➜  tar -zxvf elasticsearch-1.4.2.tar.gz</span>
<span class="go">➜  cd elasticsearch-1.4.2</span>
<span class="go">➜  ./bin/elasticsearch</span>
<span class="go">[2015-02-11 10:43:21,573][INFO ][node                     ] [Jumbo Carnation] version[1.4.2], pid[6019], build[927caff/2014-12-16T14:11:12Z]</span>
<span class="go">[2015-02-11 10:43:21,574][INFO ][node                     ] [Jumbo Carnation] initializing ...</span>
<span class="go">[2015-02-11 10:43:21,578][INFO ][plugins                  ] [Jumbo Carnation] loaded [], sites []</span>
<span class="go">[2015-02-11 10:43:23,483][INFO ][node                     ] [Jumbo Carnation] initialized</span>
<span class="go">[2015-02-11 10:43:23,483][INFO ][node                     ] [Jumbo Carnation] starting ...</span>
<span class="go">[2015-02-11 10:43:23,528][INFO ][transport                ] [Jumbo Carnation] bound_address {inet[/0:0:0:0:0:0:0:0:9300]}, publish_address {inet[/10.105.14.17:9300]}</span>
<span class="go">[2015-02-11 10:43:23,540][INFO ][discovery                ] [Jumbo Carnation] elasticsearch/_EGLpT09SfCaIbfW4KCSqg</span>
<span class="go">[2015-02-11 10:43:27,315][INFO ][cluster.service          ] [Jumbo Carnation] new_master [Jumbo Carnation][_EGLpT09SfCaIbfW4KCSqg][pumuki][inet[/10.105.14.17:9300]], reason: zen-disco-join (elected_as_master)</span>
<span class="go">[2015-02-11 10:43:27,332][INFO ][http                     ] [Jumbo Carnation] bound_address {inet[/0:0:0:0:0:0:0:0:9200]}, publish_address {inet[/10.105.14.17:9200]}</span>
<span class="go">[2015-02-11 10:43:27,332][INFO ][node                     ] [Jumbo Carnation] started</span>
<span class="go">[2015-02-11 10:43:27,783][INFO ][gateway                  ] [Jumbo Carnation] recovered [4] indices into cluster_state</span>
</pre></div>


<p>This will set elasticsearch web server listening on port 9200 on your localhost.</p>
<p>At this moment you should be able to retrieve the following information:</p>
<div class="highlight"><pre><span class="go">➜  curl -XGET http://localhost:9200/</span>
<span class="go">{</span>
<span class="go">  &quot;status&quot; : 200,</span>
<span class="go">  &quot;name&quot; : &quot;Jumbo Carnation&quot;,</span>
<span class="go">  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</span>
<span class="go">  &quot;version&quot; : {</span>
<span class="go">    &quot;number&quot; : &quot;1.4.2&quot;,</span>
<span class="go">    &quot;build_hash&quot; : &quot;927caff6f05403e936c20bf4529f144f0c89fd8c&quot;,</span>
<span class="go">    &quot;build_timestamp&quot; : &quot;2014-12-16T14:11:12Z&quot;,</span>
<span class="go">    &quot;build_snapshot&quot; : false,</span>
<span class="go">    &quot;lucene_version&quot; : &quot;4.10.2&quot;</span>
<span class="go">  },</span>
<span class="go">  &quot;tagline&quot; : &quot;You Know, for Search&quot;</span>
<span class="go">}</span>
</pre></div>


<p>You can also get the stats by doing:</p>
<div class="highlight"><pre><span class="go">➜  curl -XGET http://localhost:9200/_stats</span>
<span class="go">{&quot;_shards&quot;:{&quot;total&quot;:0,&quot;successful&quot;:0,&quot;failed&quot;:0},&quot;_all&quot;:{&quot;primaries&quot;:{},&quot;total&quot;:{}},&quot;indices&quot;:{}}</span>
</pre></div>


<p>When I was playing I processed several times different logs. So in order to clean all the information of
my elasticsearch instance I found quite useful the following command that <strong><em>will remove</em></strong> all your
existing data. So <strong><em>BE CAREFULL</em></strong>:</p>
<div class="highlight"><pre><span class="go">➜  curl -XDELETE &quot;http://localhost:9200/*&quot;</span>
<span class="go">{&quot;acknowledged&quot;:true}</span>
</pre></div>


<h3>Logstash</h3>
<p><a href="http://logstash.net/">Logstash</a> is a tool to manage events and logs. Basically you use it to collect, parse and store logs.
When used with elasticsearch you can send the processed logs structured to elasticsearch to be queried.
It's also Open Source, it's part of the elasticsearch family and you can find the source code on
the <a href="https://github.com/elasticsearch/logstash">Github project repo</a>.</p>
<p>In order to setup Logstash you will need to Download the package:</p>
<div class="highlight"><pre><span class="go">➜  wget https://download.elasticsearch.org/logstash/logstash/logstash-1.4.2.tar.gz</span>
<span class="go">➜  tar -zxvf logstashh-1.4.2.tar.gz</span>
<span class="go">➜  cd logstash-1.4.2</span>
</pre></div>


<p>To process your Access logs and send them to Elasticsearch you will need to create the logstash configuration file.
My configuration file is similar to the following one:</p>
<div class="highlight"><pre><span class="go">➜  cat logstash_simple.conf </span>
<span class="go">input {</span>
<span class="go">  file {</span>
<span class="go">    path =&gt; &quot;/var/log/access/*.log&quot;</span>
<span class="go">    type =&gt; &quot;apache_access&quot;</span>
<span class="go">  }</span>
<span class="go">}</span>

<span class="go">filter {</span>
<span class="go">  if [path] =~ &quot;access&quot; {</span>
<span class="go">    mutate { replace =&gt; { &quot;type&quot; =&gt; &quot;apache_access&quot; } }</span>
<span class="go">    grok {</span>
<span class="go">      match =&gt; { &quot;message&quot; =&gt; &quot;%{COMBINEDAPACHELOG}&quot; }</span>
<span class="go">    }</span>
<span class="go">  }</span>
<span class="go">  date {</span>
<span class="go">    match =&gt; [ &quot;timestamp&quot; , &quot;dd/MMM/yyyy:HH:mm:ss Z&quot; ]</span>
<span class="go">  }</span>
<span class="go">}</span>


<span class="go">output {</span>
<span class="go">  elasticsearch_http {</span>
<span class="go">    host =&gt; localhost </span>
<span class="go">  } </span>
<span class="go">  stdout { </span>
<span class="go">  } </span>
<span class="go">}</span>
<span class="go">➜</span>
</pre></div>


<p>In the input section we define which logs logstash needs to process. You can define
different types of input but we are basically just getting them from files. 
To see other types of input take a look at the <a href="http://logstash.net/docs/1.4.2/">documentation</a>.</p>
<p>The filter is how logstash will process your logs. We are using grok which is like a regex parser 
for unstructured data. We just use the <em>%{COMBINEDAPACHELOG}</em> regex and set the date format.</p>
<p>For the output we have created two outputs. Our Elasticsearch instance and standard output,
basically to see what is going on.</p>
<p>In order to run logstash:</p>
<div class="highlight"><pre><span class="go">➜  bin/logstash -f logstash_simple.conf</span>
</pre></div>


<h3>Kibana</h3>
<p><a href="http://www.elasticsearch.org/overview/kibana/">Kibana</a> is a visualization tool for data on top
of elasticsearch. The <a href="https://github.com/elasticsearch/kibana">Github project</a>.</p>
<p>In order to set it up just download it and run it:</p>
<div class="highlight"><pre><span class="go">➜  wget https://download.elasticsearch.org/kibana/kibana/kibana-4.0.0-beta3.tar.gz </span>
<span class="go">➜  tar -zxvf kibana-4.0.0-beta3.tar.gz</span>
<span class="go">➜  cd kibana-4.0.0-beta3</span>
<span class="go">➜  bin/kibana</span>
<span class="go">The Kibana Backend is starting up... be patient</span>
<span class="go">{&quot;@timestamp&quot;:&quot;2015-02-11T12:34:29+00:00&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;name&quot;:&quot;Kibana&quot;,&quot;message&quot;:&quot;Kibana server started on tcp://0.0.0.0:5601 in production mode.&quot;}</span>
</pre></div>


<p>And kibana should be running on your localhost at port 5601.</p>
<p>The first page will ask you to create an index. If you don't have any data yet you will not be able to create it.
Once you have created the index you can start playing querying the data.</p>
<h2>Deploy</h2>
<p>Once the Stack was locally working I thought it would be good to deploy it to one of our boxes
and send periodically our access logs to be able to have the logs updated every once in a while.</p>
<p>And I thought that maybe creating a Docker container to be able to replicate it easily on the future may
be a good possibility.</p>
<p><img alt="Docker image" src="http://raulcd.com/images/docker_logo.png" /></p>
<h3>First Approach - One to rule them all</h3>
<p>My first approach was to create a single container with the three services running on top of it.
I know that's not how you are supposed to use Docker but I wanted to try first.</p>
<p>So my idea was to have it everything running with supervisor on the docker container and add a data volume 
to the container with the logs where logstash will pick the files.</p>
<p>The code is available on <a href="https://github.com/raulcd/elk-docker">this Github repo</a>.</p>
<h4>Create the image</h4>
<p>As it is my first post about Docker I will explain a little bit how to create the image and build it.
The image created was from a basic ubuntu one and basically you need to create a file called Dockerfile
with <a href="https://github.com/raulcd/elk-docker/blob/master/Dockerfile">the information in the link</a>.</p>
<p>In order to build the container you just need to run:</p>
<div class="highlight"><pre><span class="go">➜  docker build -t elk:latest .</span>
</pre></div>


<p>This will create a local image that can be executed. You can list your images doing:</p>
<div class="highlight"><pre><span class="go">➜  docker images</span>
<span class="go">REPOSITORY                         TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span>
<span class="go">elk                                latest              28bf7af29dc1        55 seconds ago      575.7 MB</span>
</pre></div>


<h4>Running the image</h4>
<p>Once the image is built you can run it just by doing:</p>
<div class="highlight"><pre>➜  docker run -d -p 5000:5601 --name elk -v /path/access-logs:/var/log/access elk
</pre></div>


<p>This will link your local port <em>5000</em> with the port <em>5601</em> on the container (which is the kibana one) and will
add you local <em>/path/access-logs</em> to the container. Is at this path where you are supposed to be logging your
access logs.</p>
<p>TODO Images, separate containers, push the image to docker hub</p>
    </div><!-- /.entry-content -->
    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'raulcd';
        var disqus_identifier = 'elasticsearch-logstash-and-kibana-on-docker.html';
        var disqus_url = 'http://raulcd.com/elasticsearch-logstash-and-kibana-on-docker.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//raulcd.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="http://twitter.com/raulcumplido">twitter</a></li>
                            <li><a href="http://github.com/raulcd">github</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'raulcd';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>